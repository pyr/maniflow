<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title># Lifecycle management</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Maniflow</span> <span class="project-version">0.1.4</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="README.html"><div class="inner"><span># Lifecycle management</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>manifold</span></div></div></li><li class="depth-2 branch"><a href="manifold.contrib.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>contrib</span></div></a></li><li class="depth-2"><a href="manifold.lifecycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lifecycle</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#maniflow-utilities-on-top-of-manifold" name="maniflow-utilities-on-top-of-manifold"></a>maniflow: utilities on top of manifold</h1>
<p><a href="http://travis-ci.org/pyr/maniflow"><img src="https://secure.travis-ci.org/pyr/maniflow.png" alt="Build Status" /></a></p>
<pre><code class="clojure">[spootnik/maniflow "0.1.4"]
</code></pre>
<h2><a href="#lifecycle-management" name="lifecycle-management"></a>Lifecycle management</h2>
<p>The <code>manifold.lifecycle</code> namespace provides a lightweight take on a mechanism similar to <a href="http://pedestal.io/reference/interceptors">interceptors</a>.</p>
<p>A lifecycle is nothing more than a collection of handlers through which a value is passed.</p>
<p>In essence:</p>
<pre><code class="clojure">@(run 0 [inc inc inc])
</code></pre>
<p>Is thus directly equivalent to:</p>
<pre><code class="clojure">(-&gt; 0 inc inc inc)
</code></pre>
<h3><a href="#lifecycle-steps" name="lifecycle-steps"></a>Lifecycle steps</h3>
<p>As shown above, each step in a lifecycle is a handler to run on a value. Steps can be provided in several forms, all coerced to a map.</p>
<pre><code class="clojure">{:manifold.lifecycle/id        :doubler
 :manifold.lifecycle/handler   (fn [input] (* input 2))
 :manifold.lifecycle/context?  false
 :manifold.lifecycle/guard     (fn [context] ...)}
</code></pre>
<h4><a href="#function-steps" name="function-steps"></a>Function steps</h4>
<p>When a step is a plain function, as in <code>(run 0 [inc])</code>, the resulting map will be of the following shape:</p>
<pre><code class="clojure">{:manifold.lifecycle/id       :step12345
 :manifold.lifecycle/handler  inc
 :manifold.lifecycle/context? false}
</code></pre>
<p>If the function is provided as a var, the qualified name of the var is used as the id, so for <code>(run 0 [#'inc])</code> we would have instead:</p>
<pre><code class="clojure">{:manifold.lifecycle/id       :clojure.core/inc
 :manifold.lifecycle/handler  inc
 :manifold.lifecycle/context? false}
</code></pre>
<h4><a href="#accessing-and-modifying-the-context" name="accessing-and-modifying-the-context"></a>Accessing and modifying the context</h4>
<p>There are cases where accessing the context directly could be useful, in this case <code>:manifold.lifecycle/context?</code> should be set to true in the step definition:</p>
<pre><code class="clojure">(defn determine-deserialize
  [{:manifold.lifecycle/keys [input] :as context}]
  (cond-&gt; context
    (= :post (:request-method input))
	(assoc context ::need-deserialize? true)))
	
{:manifold.lifecycle/id       :determine-deserialize
 :manifold.lifecycle/handler  determine-deserialize
 :manifold.lifecycle/context? true}
</code></pre>
<h4><a href="#step-guards" name="step-guards"></a>Step guards</h4>
<p>Based on the current state of processing, it might be useful to guard execution of a step against a predicate, keeping with the last example:</p>
<pre><code class="clojure">{:manifold.lifecycle/id       :deserialize
 :manifold.lifecycle/handler  deserialize
 :manifold.lifecycle/context? false
 :manifold.lifecycle/guard    ::need-deserialize?}
</code></pre>
<h4><a href="#building-steps-with" name="building-steps-with"></a>Building steps with <code>step</code></h4>
<p>The <code>manifold.lifecycle/step</code> function is provided to build steps easily, the above can thus be rewritten:</p>
<pre><code class="clojure">(step :determine-deserialize determine-deserialize :context? true)
(step :handler run-handler)
(step :deserialize deserialize :guard :need-deserialize?)
</code></pre>
<h3><a href="#global-options" name="global-options"></a>Global options</h3>
<p>When running a lifecycle, an options map can be passed in to further modify the behavior:</p>
<pre><code class="clojure">{:manifold.lifecycle/clock    clock-implementation
 :manifold.lifecycle/context? false}
</code></pre>
<p>The clock options is an implementations of <code>spootnik.clock.Clock</code> from <a href="https://github.com/pyr/commons">commons</a> used for timing steps in the context map. <code>context?</code> defaults to false and determines whether the deferred that <code>run</code> yields the result or the context map.</p>
<h3><a href="#error-handling" name="error-handling"></a>Error handling</h3>
<p>There are intentionally no facilities to interact with the sequence of steps in this library. Exceptions thrown will break the sequence of steps, users of the library are encouraged to use <code>manifold.deferred/catch</code> to handle errors raised during execution.</p>
<p>All errors contain the underlying thrown exception as a cause and contain the last known context in their <code>ex-data</code></p>
<pre><code class="clojure">(-&gt; (d/run 0 [inc #(d/future (/ % 0)) inc])
    (d/catch (fn [e]
	            (type (.getCause e)) ;; ArithmeticException
				(:manifold.lifecycle/context (ex-data e)) ;; last context)))
</code></pre></div></div></div></body></html>